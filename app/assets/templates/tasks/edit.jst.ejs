<form class="task-edit-form" enctype="multipart/form-data">
  <% if(project){ %>
    <span class="label label-info"><%= project.get('name') %></span>
  <% } else { %>
    <span class="label label-info">Personal</span>
  <% } %>
  <% if (task.get('parent_id')) { %>
    <span class="label label-success parent-task" data-id="<%=task.get('parent_id')%>">
      <%= Breath.user.tasks().get(task.get('parent_id')).get('name') %>
    </span>
    <% } %><br><br>
  <input type='text' name="name" class="update-task"
        value="<%= task.escape('name')%>"><br><br>
  <textarea name='description' placeholder="Description" class='form-description form-control'><%= task.escape('description') %></textarea>
  <br><input type='date' name='due' value="<%= task.escape('due')%>"
    class="update-task"><br>
  <input type='text' name='tag' placeholder="Tag..." class="tag-form">
  <%= tags.length > 0 ? '<br>' : "" %>
  <% tags.forEach(function(tag){ %>
    <span class="label label-warning"> 
      <i class="icon-tag"></i> <%= tag.name %>
    </span>
  <% }) %>
  <% var com = task.get('completed') ? "Mark Incomplete" : "Mark Completed" %>
  <div class="error"></div>
  <input class="file-form" type="file" onchange="handle_files(this.files)" enctype="multipart/form-data"> 
  <% if (task.get('attachments') && task.get('attachments').length > 0) { %>
    <%= "<br>" %>
    <% task.get('attachments').forEach(function(attachment, i){ %>
    <span class="label label-inverse">
      <i class="icon-file"></i>
      <a href="<%= attachment.url %>" target="_blank"> File <%= i + 1%></a>
    </span>
    <% }) %>
    <%= "<br>" %> 
    <% } %><br>
  <button class="completed btn btn-primary"><%= com %></button>
  <br><br>
</form>

<script>
function handle_files(files) {
  var task_id = <%= task.id %>;
  var task = Breath.user.tasks().get(task_id);
  var file = files[0];
  var reader = new FileReader();
  reader.onload = function(e) {
    $.ajax({
      type: "POST",
      url: "api/tasks/" + task_id + '/upload-file',
      data: { file: e.target.result },
      success: function(){
        task.fetch();
        if (task.hasProject()) {
          var project = Breath.user.projects().get(task.get('project_id'));
          project.tasks().get(task_id).fetch();
        }
      },
      error: function(){
        $('.error').html("File could not be saved")
      }
    })
  }
  reader.onerror = function(){
  }
  reader.readAsDataURL(file);
}
</script>
